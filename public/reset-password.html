<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#667eea" />
    <link rel="manifest" href="manifest.json" />
    <title>ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u - DTDMEdu</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body>
    <!-- Theme Toggle Button -->
    <button
      id="themeToggle"
      class="theme-toggle"
      onclick="toggleTheme()"
      title="ƒê·ªïi theme (T)"
    >
      üåô
    </button>

    <div class="auth-page">
      <div class="auth-box">
        <div class="auth-brand">
          <div class="auth-badge">üîê</div>
          <h1 class="auth-title">DTDMEdu</h1>
          <p class="auth-subtitle">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u c·ªßa b·∫°n</p>
        </div>

        <!-- Form ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u -->
        <div id="resetForm" class="form-container active">
          <h2 style="margin: 0 0 14px">M·∫≠t Kh·∫©u M·ªõi</h2>
          <form onsubmit="handleResetPassword(event)">
            <div class="form-group">
              <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
              <input
                type="password"
                id="newPassword"
                required
                minlength="6"
                placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
              />
            </div>

            <div class="form-group">
              <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
              <input
                type="password"
                id="confirmPassword"
                required
                minlength="6"
                placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
              />
            </div>

            <button
              type="submit"
              class="btn btn-primary"
              style="width: 100%"
              id="submitBtn"
            >
              üîë ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u
            </button>
          </form>

          <p class="switch-form">
            <a href="login.html">‚Üê Quay v·ªÅ ƒëƒÉng nh·∫≠p</a>
          </p>
        </div>

        <!-- Success message -->
        <div id="successMessage" class="form-container" style="display: none">
          <div style="text-align: center">
            <div style="font-size: 4rem; margin-bottom: 20px">‚úÖ</div>
            <h2 style="margin: 0 0 14px; color: #22c55e">Th√†nh C√¥ng!</h2>
            <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px">
              M·∫≠t kh·∫©u c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.
            </p>
            <a
              href="login.html"
              class="btn btn-primary"
              style="display: inline-block"
            >
              ƒêƒÉng nh·∫≠p ngay
            </a>
          </div>
        </div>

        <!-- Error message -->
        <div id="errorMessage" class="form-container" style="display: none">
          <div style="text-align: center">
            <div style="font-size: 4rem; margin-bottom: 20px">‚ùå</div>
            <h2 style="margin: 0 0 14px; color: #ef4444">L·ªói!</h2>
            <p
              id="errorText"
              style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px"
            >
              Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.
            </p>
            <a
              href="login.html"
              class="btn btn-secondary"
              style="display: inline-block"
            >
              Quay v·ªÅ ƒëƒÉng nh·∫≠p
            </a>
          </div>
        </div>
      </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
      const API_URL = "http://localhost:3000/api";

      // L·∫•y token t·ª´ URL
      function getTokenFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("token");
      }

      // Ki·ªÉm tra token khi load trang
      window.onload = function () {
        const token = getTokenFromUrl();
        if (!token) {
          showError("Kh√¥ng t√¨m th·∫•y token. Vui l√≤ng s·ª≠ d·ª•ng link t·ª´ email.");
        }
      };

      // X·ª≠ l√Ω ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u
      async function handleResetPassword(e) {
        e.preventDefault();

        const token = getTokenFromUrl();
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        // Validate
        if (!token) {
          showNotification("Token kh√¥ng h·ª£p l·ªá!", "error");
          return;
        }

        if (newPassword.length < 6) {
          showNotification("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!", "error");
          return;
        }

        if (newPassword !== confirmPassword) {
          showNotification("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!", "error");
          return;
        }

        // Disable button
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";

        try {
          const response = await fetch(`${API_URL}/reset-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, newPassword }),
          });

          const data = await response.json();

          if (data.success) {
            showSuccess();
          } else {
            showError(data.message || "ƒê√£ c√≥ l·ªói x·∫£y ra!");
          }
        } catch (error) {
          console.error("Reset password error:", error);
          showError("L·ªói k·∫øt n·ªëi server!");
        }
      }

      // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
      function showSuccess() {
        document.getElementById("resetForm").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("successMessage").style.display = "block";
      }

      // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
      function showError(message) {
        document.getElementById("resetForm").style.display = "none";
        document.getElementById("successMessage").style.display = "none";
        document.getElementById("errorText").textContent = message;
        document.getElementById("errorMessage").style.display = "block";
      }

      // Hi·ªÉn th·ªã notification
      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type}`;
        setTimeout(() => (notification.className = "notification"), 3000);
      }

      // ================ THEME SUPPORT ================
      function loadTheme() {
        const savedTheme = localStorage.getItem("theme") || "dark";
        document.documentElement.setAttribute("data-theme", savedTheme);
        updateThemeButton();
      }

      function toggleTheme() {
        const current = document.documentElement.getAttribute("data-theme");
        const newTheme = current === "light" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeButton();
      }

      function updateThemeButton() {
        const btn = document.getElementById("themeToggle");
        if (btn) {
          const theme = document.documentElement.getAttribute("data-theme");
          btn.textContent = theme === "light" ? "‚òÄÔ∏è" : "üåô";
        }
      }

      // ================ KEYBOARD SHORTCUTS ================
      function initKeyboardShortcuts() {
        document.addEventListener("keydown", (e) => {
          if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") {
            return;
          }

          const key = e.key.toLowerCase();

          // Toggle theme with T key
          if (key === "t") {
            toggleTheme();
          }
        });
      }

      // Load theme on page load
      window.addEventListener("DOMContentLoaded", () => {
        loadTheme();
        initKeyboardShortcuts();
      });
    </script>
  </body>
</html>
